#!/usr/bin/env coffee

[coffee, cssh, invokedAs, remainingArgs...] = process.argv

buffer = ''
allLines = []

try
  {perLine, withAllLines, withError} = require invokedAs
  [_perLine, _withAllLines, _withError] = [perLine, withAllLines, withError]

  if not (perLine or withAllLines or withError)
    console.log "WARNING: #{invokedAs} isn't using any known hooks. Input will be ignored."

  _perLine      ?= ->
  _withAllLines ?= ->
  _withError    ?= (err) -> throw err

  withError = (err) ->
    try
      withError err
    catch e
      throw e

  perLine = (line) ->
    allLines.push line

    try
      _perLine line
    catch e
      withError e

  withAllLines = (lines) ->
    try
      _withAllLines lines
    catch e
      withError e

catch err
  console.log "Error loading #{invokedAs}: #{err}"
  process.exit -1

try
  process.stdin
    .resume()

    .on 'data', (d) ->
      buffer += d.toString 'utf-8'

      while (eol = buffer.indexOf '\n') > -1
        line = buffer.substr 0, eol
        buffer = buffer.substr eol + 1
        perLine line

    .on 'end', ->
      if buffer.length
        perLine line

      withAllLines allLines

    .on 'error', (e) ->
      withError e

catch e
  withError e
