doWhenever = dw = (registerResult, fn) ->
  id = dw.id++
  dw.status[id] = 'requested'

  randomSleep = dw.min +
    Math.random() * (dw.max - dw.min)

  setTimeout (->
    try
      ret = fn()
    catch err
      'it seems wrong not to have something here'
      'but I just wanted to set err'

    delete dw.status[id]
    registerResult {ret, err}
  ), randomSleep

  setTimeout (->
    if dw.status[id] is 'requested'
      delete dw.status[id]
      registerResult {timeout: true}
  ), randomSleep + dw.gracePeriod

Object.assign doWhenever,
  status      : {}
  min         : 100
  max         : 600
  gracePeriod : 1000
  id          : 0

assert   = require 'assert'
throttle = require '..'


